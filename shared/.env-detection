# Environment Detection Functions
# Source this file to get smart environment detection

# Detect if we're in a container
is_container() {
    [ -f /.dockerenv ] || [ -f /run/.containerenv ] || grep -q docker /proc/1/cgroup 2>/dev/null
}

# Detect if we're in WSL
is_wsl() {
    [ -n "${WSL_DISTRO_NAME:-}" ] || grep -qEi "(Microsoft|WSL)" /proc/version 2>/dev/null
}

# Detect if we're in a VM
is_vm() {
    command -v systemd-detect-virt >/dev/null && systemd-detect-virt -q
}

# Detect if we're on a remote machine via SSH
is_ssh() {
    [ -n "${SSH_CLIENT:-}" ] || [ -n "${SSH_TTY:-}" ]
}

# Detect CI environment
is_ci() {
    [ -n "${CI:-}" ] || [ -n "${BUILD_NUMBER:-}" ] || [ -n "${GITHUB_ACTIONS:-}" ]
}

# Get OS type
get_os() {
    case "$(uname -s)" in
        Darwin) echo "macos" ;;
        Linux) echo "linux" ;;
        *) echo "unknown" ;;
    esac
}

# Smart terminal title
set_terminal_title() {
    local title="$1"
    case "$TERM" in
        xterm*|rxvt*|screen*|tmux*)
            printf '\033]0;%s\007' "$title"
            ;;
    esac
}

# Performance mode detection (useful for VMs with limited resources)
is_performance_mode() {
    # Enable performance mode if:
    # - Running in container
    # - Less than 4GB RAM
    # - Running on VM with limited CPU
    if is_container; then
        return 0
    fi

    local ram_gb=$(free -g 2>/dev/null | awk '/^Mem:/{print $2}' || echo "8")
    [ "$ram_gb" -lt 4 ]
}
name: Update Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'packages.yaml'
      - 'shared/**'
      - 'macos/**'
      - 'ubuntu/**'
  workflow_dispatch:

jobs:
  update-package-docs:
    name: Update Package Documentation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        pip install pyyaml

    - name: Generate package documentation
      run: |
        python3 << 'EOF'
        import yaml
        import json

        # Read packages.yaml
        with open('packages.yaml', 'r') as f:
            packages = yaml.safe_load(f)

        # Generate package counts for README badges
        total_packages = 0
        for category, data in packages.items():
            if 'packages' in data:
                total_packages += len(data['packages'])

        print(f"Total packages: {total_packages}")

        # Create a JSON file with package info for potential use
        with open('package-info.json', 'w') as f:
            json.dump({
                'total_packages': total_packages,
                'categories': list(packages.keys()),
                'last_updated': '2024-01-01'  # This would be dynamically set
            }, f, indent=2)
        EOF

    - name: Check for documentation inconsistencies
      run: |
        echo "ðŸ” Checking for documentation inconsistencies..."

        # Check if all scripts mentioned in README exist
        if grep -o '\./[^[:space:]]*\.sh' README.md | while read -r script; do
          if [ ! -f "$script" ]; then
            echo "âŒ Script mentioned in README but not found: $script"
            exit 1
          fi
        done; then
          echo "âœ… All scripts mentioned in README exist"
        fi

        # Check if all aliases in README are defined
        # (This is a simplified check - could be more sophisticated)
        echo "ðŸ“ Documentation consistency check complete"

    - name: Update README badges
      run: |
        # Update package count badge if needed
        PACKAGE_COUNT=$(python3 -c "
        import yaml
        with open('packages.yaml', 'r') as f:
            packages = yaml.safe_load(f)
        count = sum(len(data.get('packages', [])) for data in packages.values())
        print(count)
        ")

        echo "Package count: $PACKAGE_COUNT"

        # Could update README with current package count
        # sed -i "s/packages-%20[0-9]*/packages%20$PACKAGE_COUNT/g" README.md

    - name: Generate tool summary
      run: |
        echo "ðŸ”§ Generating tool summary..."

        python3 << 'EOF'
        import yaml

        with open('packages.yaml', 'r') as f:
            packages = yaml.safe_load(f)

        print("# ðŸ“¦ Package Summary\n")

        for category, data in packages.items():
            if 'packages' in data:
                print(f"## {category.title()}")
                print(f"*{data.get('description', 'No description')}*\n")

                for pkg in data['packages']:
                    name = pkg['name']
                    desc = pkg.get('description', 'No description')
                    optional = pkg.get('optional', False)
                    status = ' (optional)' if optional else ''
                    print(f"- **{name}**{status}: {desc}")

                print()
        EOF

    - name: Check for broken links
      run: |
        echo "ðŸ”— Checking for broken links in README..."

        # Extract GitHub links and check if repositories exist
        grep -o 'https://github.com/[^[:space:])]]*' README.md | sort -u | while read -r url; do
          repo_path=$(echo "$url" | sed 's|https://github.com/||')

          # Check if it's a valid GitHub repo (simplified check)
          if curl -s -o /dev/null -w "%{http_code}" "https://api.github.com/repos/$repo_path" | grep -q "200"; then
            echo "âœ… Valid: $url"
          else
            echo "âš ï¸  Potentially broken: $url"
          fi
        done

    - name: Validate configuration files
      run: |
        echo "âš™ï¸ Validating configuration files..."

        # Check if all referenced files in install.conf.yaml exist
        if [ -f "install.conf.yaml" ]; then
          # Extract file paths from YAML (simplified)
          grep -E "^\s*~/" install.conf.yaml | while read -r line; do
            target=$(echo "$line" | cut -d':' -f2 | xargs)
            if [ -n "$target" ] && [ ! -f "$target" ]; then
              echo "âš ï¸  Referenced file not found: $target"
            fi
          done
        fi

    - name: Create documentation update PR
      if: github.event_name == 'push'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          docs: automated documentation updates

          ðŸ¤– Generated from configuration changes
        title: 'ðŸ“š Automated Documentation Updates'
        body: |
          ## ðŸ“š Documentation Updates

          This PR contains automated documentation updates triggered by changes to:
          - Package configurations
          - Shell configurations
          - Installation scripts

          ## ðŸ” Changes Include
          - Package count updates
          - Link validation
          - Configuration validation
          - Tool summary generation

          ðŸ¤– This PR was created automatically by GitHub Actions.
        branch: automated-docs-update
        delete-branch: true